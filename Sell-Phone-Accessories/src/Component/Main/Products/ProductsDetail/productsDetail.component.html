<!-- Loading & Error -->
<div *ngIf="loading">ƒêang t·∫£i...</div>
<div *ngIf="error && !loading" class="error">{{ error }}</div>

<!-- MAIN: ch·ªâ render khi ƒë√£ c√≥ d·ªØ li·ªáu -->
<div *ngIf="product as p" class="product-detail">
  <!-- ========== LEFT: MEDIA GRID ========== -->
  <aside class="media-column">
    <!-- ·∫£nh preview l·ªõn -->
    <div class="main-preview" *ngIf="activeImageUrl">
      <img [src]="activeImageUrl" [alt]="p.name" />
    </div>

    <!-- l∆∞·ªõi 4 ·∫£nh ph·ª• (ƒë√£ chu·∫©n ho√° trong TS) -->
    <div class="media-grid">
      <button
        class="tile"
        *ngFor="let img of p.mediaImages; let i = index"
        [attr.aria-label]="'Open image ' + (i + 1)"
        (click)="selectImage(img.url)"
      >
        <img [src]="img.url" [alt]="p.name + ' - image ' + (i + 1)" />
      </button>
    </div>
  </aside>

  <!-- ========== RIGHT: INFO ========== -->
  <section class="info-column">
    <h1 class="pd-title">{{ p.name }}</h1>

    <!-- rating + links -->
    <div class="meta-row">
      <div
        class="stars"
        [attr.aria-label]="(p.rate ?? 0).toFixed(1) + ' stars'"
      >
        <ng-container *ngFor="let s of starsArray(); let i = index">
          <span class="s" [class.s-on]="s === 1">‚òÖ</span>
        </ng-container>
      </div>
      <a class="meta-link" href="javascript:void(0)">Reviews</a>
      <span class="dot">‚Ä¢</span>
      <a class="meta-link" href="javascript:void(0)">Product Details</a>
    </div>

    <!-- price + promo -->
    <div class="pd-price">
      {{ priceFormatted(p.finalPrice) }}
      <span class="strike" *ngIf="p.finalPrice < p.price">
        {{ priceFormatted(p.price) }}
      </span>
    </div>
    <p class="promo" *ngIf="(p.discount ?? 0) > 0">
      Deal: <b>{{ p.discount }}% off</b>
      <a href="javascript:void(0)">(See Details)</a>
    </p>

    <!-- color + availability -->
    <div class="attr-line">
      <span class="label">Color Name:</span>
      <span class="value">{{ p.colorName ?? "‚Äî" }}</span>
      <a class="meta-link" href="javascript:void(0)">Shop Color</a>
    </div>

    <div class="attr-line">
      <label class="label" for="availability">Availability</label>
      <select id="availability" class="select small" [value]="p.availability">
        <option>In Stock</option>
        <option>Out of Stock</option>
      </select>
      <span class="sku">{{ p.sku }}</span>
    </div>

    <!-- qty + add to cart -->
    <div class="qty-add-row">
      <div class="qty">
        <button class="qty-btn" (click)="adjustQty(-1)">‚àí</button>
        <input
          class="qty-input"
          [value]="qty"
          inputmode="numeric"
          (input)="onQtyManualChange($any($event.target).value)"
        />
        <button class="qty-btn" (click)="adjustQty(1)">+</button>
      </div>

      <button
        class="btn-cart"
        [disabled]="p.availability !== 'In Stock'"
        (click)="addToCart()"
      >
        ADD TO CART
      </button>
    </div>

    <!-- === Buy Now section === -->
    <div class="hr-title"><span>Buy Now</span></div>
    <div class="buy-now-row">
      <button
        class="btn-buy"
        [disabled]="p.availability !== 'In Stock'"
        (click)="buyNow()"
      >
        Buy Now
      </button>
    </div>

    <!-- service badges -->
    <div class="service-badges">
      <div class="badge">
        <span class="ico check">‚úì</span>
        <span>Supported by hassle-free customer service</span>
      </div>
      <div class="badge">
        <span class="ico shield">üõ°</span>
        <span>Backed by our limited warranty, no registration required</span>
      </div>
    </div>

    <!-- add accessories (demo) -->
    <div class="upsell">
      <h3 class="upsell-title">Add Accessories</h3>
      <ul class="upsell-list">
        <li class="upsell-item">
          <div class="u-left">
            <img src="https://via.placeholder.co/60x60" alt="" />
            <div class="u-meta">
              <div class="u-name">Galaxy S25 FE Holster</div>
              <div class="u-price">$19.99</div>
            </div>
          </div>
          <button class="u-add">+ ADD</button>
        </li>

        <li class="upsell-item">
          <div class="u-left">
            <img src="https://via.placeholder.co/60x60" alt="" />
            <div class="u-meta">
              <div class="u-name">USB-C Wall Charger ¬∑ 30W</div>
              <div class="u-price">$34.95</div>
            </div>
          </div>
          <button class="u-add">+ ADD</button>
        </li>

        <li class="upsell-item">
          <div class="u-left">
            <img src="https://via.placeholder.co/60x60" alt="" />
            <div class="u-meta">
              <div class="u-name">OtterSpot Wireless Charging System</div>
              <div class="u-price strike">$64.95</div>
              <div class="u-price sale">$38.46</div>
            </div>
          </div>
          <button class="u-add">+ ADD</button>
        </li>
      </ul>
    </div>
  </section>
</div>

<!-- ===== Tabs header ===== -->
<section *ngIf="product as p" class="pd-tabs">
  <div class="tabs-row">
    <a class="tab-link active" href="#pd-details">Product Details</a>
    <a class="tab-link" href="javascript:void(0)">Frequently Asked Questions</a>
    <a class="tab-link" href="javascript:void(0)">Reviews</a>
  </div>
</section>

<!-- ===== Product Details body ===== -->
<section *ngIf="product as p" id="pd-details" class="pd-section">
  <div class="pd-cols">
    <!-- LEFT -->
    <div class="pd-col-left">
      <h2 class="pd-h2">Description</h2>
      <p class="pd-desc">{{ p.description ?? "" }}</p>

      <h3 class="pd-h3">Features</h3>
      <ul class="pd-features">
        <!-- demo features; c√≥ th·ªÉ bind t·ª´ API n·∫øu backend c√≥ -->
        <li>Raised edges protect camera + screen</li>
        <li>Textured all over for peak grip</li>
        <li>Built-in magnets work with MagSafe accessories</li>
      </ul>
    </div>

    <!-- RIGHT -->
    <div class="pd-col-right">
      <dl class="pd-specs">
        <!-- Compatibility -->
        <div class="spec-row" *ngIf="toArray(p.compatibility).length">
          <dt>Compatibility</dt>
          <dd>
            <ul class="bullets">
              <li *ngFor="let c of toArray(p.compatibility)">{{ c }}</li>
            </ul>
          </dd>
        </div>

        <!-- Dimensions -->
        <div class="spec-row" *ngIf="p.dimensions">
          <dt>Dimensions</dt>
          <dd>
            <ul class="bullets">
              <li>{{ p.dimensions }}</li>
            </ul>
          </dd>
        </div>

        <!-- Weight -->
        <div
          class="spec-row"
          *ngIf="p.weight !== null && p.weight !== undefined"
        >
          <dt>Weight</dt>
          <dd>
            <ul class="bullets">
              <li>{{ p.weight }}</li>
            </ul>
          </dd>
        </div>

        <!-- Materials -->
      <div class="spec-row" *ngIf="toArray(p.materials).length">
  <dt>Materials</dt>
  <dd>
    <ul class="bullets">
      <li *ngFor="let m of toArray(p.materials)">{{ m }}</li>
    </ul>
  </dd>
</div>

      </dl>

      <div class="pd-warning">
        <span class="ico" aria-hidden="true">‚ö†</span>
        <span>
          <strong>WARNING:</strong> Reproductive Harm ‚Äî
          <a
            href="https://www.P65Warnings.ca.gov"
            target="_blank"
            rel="noopener"
            >www.P65Warnings.ca.gov</a
          >
        </span>
      </div>
    </div>
  </div>
</section>
